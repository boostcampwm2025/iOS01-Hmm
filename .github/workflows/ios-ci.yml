name: iOS CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Find latest iOS Simulator
      id: find-simulator
      run: |
        echo "ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œë®¬ë ˆì´í„° ê²€ìƒ‰ ì¤‘..."
        
        # simctlì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥í•œ iPhone ì‹œë®¬ë ˆì´í„° ê°€ì ¸ì˜¤ê¸°
        DESTINATIONS=$(xcrun simctl list devices available | grep "iPhone")
        
        echo "ğŸ“‹ ì°¾ì€ iPhone ì‹œë®¬ë ˆì´í„°:"
        echo "$DESTINATIONS"
        
        # ìµœì‹  iPhone ì°¾ê¸° (iPhone 17, 16, 15 ìˆœì„œë¡œ)
        SIMULATOR_ID=""
        for PHONE in "iPhone 17 Pro Max" "iPhone 17 Pro" "iPhone 17" "iPhone 16 Pro Max" "iPhone 16 Pro" "iPhone 16 Plus" "iPhone 16" "iPhone 15" "iPhone 14" "iPhone SE"; do
          FOUND=$(echo "$DESTINATIONS" | grep "$PHONE" | tail -1)
          if [ ! -z "$FOUND" ]; then
            echo "âœ… '$PHONE' ë°œê²¬!"
            # UUID ì¶”ì¶œ
            SIMULATOR_ID=$(echo "$FOUND" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}')
            SIMULATOR_NAME=$(echo "$FOUND" | sed -E 's/^[[:space:]]*([^(]+).*/\1/' | xargs)
            
            echo "simulator_id=$SIMULATOR_ID" >> $GITHUB_OUTPUT
            echo "simulator_name=$SIMULATOR_NAME" >> $GITHUB_OUTPUT
            echo "âœ… ì„ íƒëœ ì‹œë®¬ë ˆì´í„°: $SIMULATOR_NAME"
            echo "ğŸ“± ì‹œë®¬ë ˆì´í„° ID: $SIMULATOR_ID"
            break
          fi
        done
        
        # ì‹œë®¬ë ˆì´í„°ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš°
        if [ -z "$SIMULATOR_ID" ]; then
          echo "âŒ ì‚¬ìš© ê°€ëŠ¥í•œ iPhone ì‹œë®¬ë ˆì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
          echo "ğŸ“‹ ì „ì²´ ì‹œë®¬ë ˆì´í„° ëª©ë¡:"
          xcrun simctl list devices available
          exit 1
        fi
        
    - name: Show selected simulator
      run: |
        echo "ğŸ¯ ì‚¬ìš©í•  ì‹œë®¬ë ˆì´í„°: ${{ steps.find-simulator.outputs.simulator_name }}"
        echo "ğŸ†” ì‹œë®¬ë ˆì´í„° ID: ${{ steps.find-simulator.outputs.simulator_id }}"
      
    - name: Cache SPM packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          **/Package.resolved
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
    
    - name: Build SoloDeveloperTraining
      run: |
        cd SoloDeveloperTraining
        xcodebuild clean build \
          -project SoloDeveloperTraining.xcodeproj \
          -scheme SoloDeveloperTraining \
          -destination "platform=iOS Simulator,id=${{ steps.find-simulator.outputs.simulator_id }}" \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO
    
    - name: Test SoloDeveloperTraining
      run: |
        cd SoloDeveloperTraining
        xcodebuild test \
          -project SoloDeveloperTraining.xcodeproj \
          -scheme SoloDeveloperTraining \
          -destination "platform=iOS Simulator,id=${{ steps.find-simulator.outputs.simulator_id }}" \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          || echo "No tests found or tests failed - continuing..."
