name: iOS CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Find latest iOS Simulator
      id: find-simulator
      run: |
        echo "ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œë®¬ë ˆì´í„° ê²€ìƒ‰ ì¤‘..."
        
        # simctlì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥í•œ iPhone ì‹œë®¬ë ˆì´í„° ê°€ì ¸ì˜¤ê¸°
        ALL_DEVICES=$(xcrun simctl list devices available | grep "iPhone")
        
        echo "ğŸ“‹ ì°¾ì€ iPhone ì‹œë®¬ë ˆì´í„°:"
        echo "$ALL_DEVICES"
        
        # ìˆ«ìê°€ ìˆëŠ” iPhoneë§Œ ì¶”ì¶œí•˜ê³  ë²ˆí˜¸ë¡œ ì •ë ¬ (iPhone 16, 17, 18... ë“±)
        # sedë¡œ "iPhone <ìˆ«ì>" íŒ¨í„´ë§Œ ì¶”ì¶œí•˜ê³ , ìˆ«ìë¡œ ì •ë ¬í•˜ì—¬ ê°€ì¥ í° ê²ƒ ì„ íƒ
        NUMBERED_IPHONES=$(echo "$ALL_DEVICES" | grep -E "iPhone [0-9]+" | sed -E 's/.*iPhone ([0-9]+).*/\1/' | sort -n -u)
        LATEST_NUMBER=$(echo "$NUMBERED_IPHONES" | tail -1)
        
        echo "ğŸ“Š ì°¾ì€ iPhone ë²„ì „: $(echo $NUMBERED_IPHONES | tr '\n' ' ')"
        echo "ğŸ¯ ìµœì‹  ë²„ì „: iPhone $LATEST_NUMBER"
        
        # ìµœì‹  ë²„ì „ì˜ iPhoneì„ ìš°ì„ ìˆœìœ„ë¡œ ì°¾ê¸° (Pro Max > Pro > Plus > ê¸°ë³¸)
        SIMULATOR_ID=""
        for MODEL in "iPhone $LATEST_NUMBER Pro Max" "iPhone $LATEST_NUMBER Pro" "iPhone $LATEST_NUMBER Plus" "iPhone $LATEST_NUMBER"; do
          FOUND=$(echo "$ALL_DEVICES" | grep "$MODEL" | tail -1)
          if [ ! -z "$FOUND" ]; then
            echo "âœ… '$MODEL' ë°œê²¬!"
            # UUID ì¶”ì¶œ
            SIMULATOR_ID=$(echo "$FOUND" | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}')
            SIMULATOR_NAME=$(echo "$FOUND" | sed -E 's/^[[:space:]]*([^(]+).*/\1/' | xargs)
            
            echo "simulator_id=$SIMULATOR_ID" >> $GITHUB_OUTPUT
            echo "simulator_name=$SIMULATOR_NAME" >> $GITHUB_OUTPUT
            echo "âœ… ì„ íƒëœ ì‹œë®¬ë ˆì´í„°: $SIMULATOR_NAME"
            echo "ğŸ“± ì‹œë®¬ë ˆì´í„° ID: $SIMULATOR_ID"
            break
          fi
        done
        
        # ì‹œë®¬ë ˆì´í„°ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš°
        if [ -z "$SIMULATOR_ID" ]; then
          echo "âŒ ì‚¬ìš© ê°€ëŠ¥í•œ iPhone ì‹œë®¬ë ˆì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
          echo "ğŸ“‹ ì „ì²´ ì‹œë®¬ë ˆì´í„° ëª©ë¡:"
          xcrun simctl list devices available
          exit 1
        fi
        
    - name: Show selected simulator
      run: |
        echo "ğŸ¯ ì‚¬ìš©í•  ì‹œë®¬ë ˆì´í„°: ${{ steps.find-simulator.outputs.simulator_name }}"
        echo "ğŸ†” ì‹œë®¬ë ˆì´í„° ID: ${{ steps.find-simulator.outputs.simulator_id }}"
      
    - name: Cache SPM packages
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          **/Package.resolved
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
    
    - name: Build SoloDeveloperTraining
      run: |
        cd SoloDeveloperTraining
        xcodebuild clean build \
          -project SoloDeveloperTraining.xcodeproj \
          -scheme SoloDeveloperTraining \
          -destination "platform=iOS Simulator,id=${{ steps.find-simulator.outputs.simulator_id }}" \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO
    
    - name: Test SoloDeveloperTraining
      run: |
        cd SoloDeveloperTraining
        xcodebuild test \
          -project SoloDeveloperTraining.xcodeproj \
          -scheme SoloDeveloperTraining \
          -destination "platform=iOS Simulator,id=${{ steps.find-simulator.outputs.simulator_id }}" \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          || echo "No tests found or tests failed - continuing..."