name: Release Note Generator

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  create_release_note:
    # PRì´ ì‹¤ì œë¡œ mergeë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Xcode í”„ë¡œì íŠ¸ì—ì„œ ë²„ì „ ì •ë³´ ì¶”ì¶œ
      - name: Extract Xcode version info
        id: xcode_version
        run: |
          # í”„ë¡œì íŠ¸ ì´ë¦„
          PROJECT_NAME="SoloDeveloperTraining"
          
          # MARKETING_VERSION ì¶”ì¶œ
          MARKETING_VERSION=$(grep -m 1 "MARKETING_VERSION = " "${PROJECT_NAME}/${PROJECT_NAME}.xcodeproj/project.pbxproj" | sed 's/.*MARKETING_VERSION = \(.*\);/\1/' | tr -d ' ')
          
          # BUILD_NUMBER ì¶”ì¶œ
          BUILD_NUMBER=$(grep -m 1 "CURRENT_PROJECT_VERSION = " "${PROJECT_NAME}/${PROJECT_NAME}.xcodeproj/project.pbxproj" | awk -F'[ ;]' '{print $3}')
          
          echo "marketing_version=$MARKETING_VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          
          echo "ğŸ“± Extracted Marketing Version: $MARKETING_VERSION"
          echo "ğŸ”¢ Extracted Build Number: $BUILD_NUMBER"
      
      # ë²„ì „ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.xcode_version.outputs.marketing_version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag v${{ steps.xcode_version.outputs.marketing_version }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag v${{ steps.xcode_version.outputs.marketing_version }} does not exist"
          fi

      # main ë¸Œëœì¹˜ì— í¬í•¨ëœ ì»¤ë°‹ì„ ê¸°ì¤€ìœ¼ë¡œ PR ì¡°íšŒ
      - name: Get merged PRs in main branch
      # ë™ì¼í•œ íƒœê·¸ê°€ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš°ë§Œ ì‹¤í–‰
        if: steps.check_tag.outputs.exists == 'false'
        id: get_prs
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const owner = context.repo.owner;
              const repo  = context.repo.repo;
              const pull_number = context.payload.pull_request.number;

              const prNumbers = new Set();

              console.log(`ğŸ” Analyzing commits from merged PR #${pull_number}...`);

              // 1. í˜„ì¬ mainìœ¼ë¡œ ë¨¸ì§€ëœ PRì— í¬í•¨ëœ ëª¨ë“  ì»¤ë°‹ ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
              const commits = await github.paginate(
                github.rest.pulls.listCommits,
                {
                  owner,
                  repo,
                  pull_number: pull_number
                }
              );

              // 2. ê° ì»¤ë°‹ê³¼ ì—°ê²°ëœ PRë“¤ì„ ì—­ì¶”ì í•©ë‹ˆë‹¤.
              for (const commit of commits) {
                const linkedPRs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner,
                  repo,
                  commit_sha: commit.sha
                });
                
                linkedPRs.data.forEach(pr => {
                  // ë¨¸ì§€ëœ PRì´ê³ , í˜„ì¬ mainìœ¼ë¡œ ë¨¸ì§€ëœ PR ìì²´ê°€ ì•„ë‹Œ ê²½ìš°(í•˜ìœ„ PRì¸ ê²½ìš°) ì¶”ê°€
                  if (pr.merged_at && pr.number !== pull_number) {
                    prNumbers.add(pr.number);
                  }
                });
              }

              // 3. í˜„ì¬ PRì„ í¬í•¨ì‹œí‚µë‹ˆë‹¤.
              prNumbers.add(pull_number);

              console.log(`âœ… Found ${prNumbers.size} unique sub-PRs.`);

              const prDetails = [];
              for (const number of Array.from(prNumbers)) {
                const { data: pr } = await github.rest.pulls.get({
                  owner,
                  repo,
                  pull_number: number
                });
                prDetails.push(pr);
              }

              prDetails.sort((a, b) => new Date(b.merged_at) - new Date(a.merged_at));

              // 4. PR ë¼ë²¨ì— ë”°ë¼ ì¹´í…Œê³ ë¼ì´ì§• í•©ë‹ˆë‹¤.
              const features = prDetails.filter(pr => pr.labels.some(l => ['Feature','UI','Design'].includes(l.name)));
              const bugfixes = prDetails.filter(pr => pr.labels.some(l => ['Fix','Bug'].includes(l.name)));
              const maintenance = prDetails.filter(pr => pr.labels.some(l => ['Chore','Refactor','Remove','Docs','Test'].includes(l.name)));
              const others = prDetails.filter(pr => !pr.labels.some(l => ['Feature','UI','Design','Fix','Bug','Chore','Refactor','Remove','Docs','Test','Someday','Release'].includes(l.name)));

              console.log(`ğŸ“Š PR Breakdown - Features: ${features.length}, Fixes: ${bugfixes.length}, Maint: ${maintenance.length}, Others: ${others.length}`);
              
              // 5. ë¬¸ì„œ ë‚´ìš©ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
              let releaseNotes = '## What\'s Changed\n\n';
              const formatPR = (pr) => `- ${pr.title} @${pr.user.login} ([#${pr.number}](${pr.html_url}))\n`;

              if (features.length) releaseNotes += `### ğŸš€ New Features\n${features.map(formatPR).join('')}\n`;
              if (bugfixes.length) releaseNotes += `### ğŸ› Bug Fixes\n${bugfixes.map(formatPR).join('')}\n`;
              if (maintenance.length) releaseNotes += `### ğŸš© Maintenance\n${maintenance.map(formatPR).join('')}\n`;
              if (others.length) releaseNotes += `### ğŸ“ Others\n${others.map(formatPR).join('')}\n`;

              return releaseNotes;

            } catch (error) {
              console.error('âŒ Error:', error.message);
              core.setFailed(error.message);
              throw error;
            }

      # ë¦´ë¦¬ì¦ˆ ìƒì„± ë° ì—…ë°ì´íŠ¸
      - name: Create or Update Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const marketingVersion = '${{ steps.xcode_version.outputs.marketing_version }}';
              const buildNumber = '${{ steps.xcode_version.outputs.build_number }}';
              const tagName = `v${marketingVersion}`;
              const releaseNotes = ${{ steps.get_prs.outputs.result }};
              
              if (!marketingVersion || marketingVersion === '') {
                throw new Error('Marketing version is empty or invalid');
              }
              if (!buildNumber || buildNumber === '') {
                throw new Error('Build number is empty or invalid');
              }
              
              console.log(`ğŸ“¦ Creating/updating release: ${tagName}`);
              console.log(`ğŸ“± Version: ${marketingVersion}`);
              console.log(`ğŸ”¢ Build: ${buildNumber}`);
              
              const fullReleaseNotes = `**Version**: ${marketingVersion}\n**Build**: ${buildNumber}\n\n${releaseNotes}`;
              
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const existingRelease = releases.find(r => r.tag_name === tagName);
              
              if (existingRelease) {
                console.log(`ğŸ”„ Updating existing release: ${tagName}`);
                await github.rest.repos.updateRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: existingRelease.id,
                  body: fullReleaseNotes
                });
                console.log(`âœ… Updated release: ${tagName} (Build: ${buildNumber})`);
              } else {
                console.log(`ğŸ†• Creating new release: ${tagName}`);
                const release = await github.rest.repos.createRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: tagName,
                  name: `v${marketingVersion}`,
                  body: fullReleaseNotes,
                  draft: false,
                  prerelease: false
                });
                console.log(`âœ… Created release: ${tagName} (Build: ${buildNumber})`);
                console.log(`ğŸ”— Release URL: ${release.data.html_url}`);
              }
              
            } catch (error) {
              console.error('âŒ Error creating/updating release:', error.message);
              core.setFailed(`Failed to create/update release: ${error.message}`);
              throw error;
            }