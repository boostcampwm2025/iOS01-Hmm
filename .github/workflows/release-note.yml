name: Release Note Generator

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  update_release_draft:
    # PRì´ ì‹¤ì œë¡œ mergeë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Xcode í”„ë¡œì íŠ¸ì—ì„œ ë²„ì „ ì •ë³´ ì¶”ì¶œ
      - name: Extract Xcode version info
        id: xcode_version
        run: |
          PROJECT_NAME="SoloDeveloperTraining"  # í”„ë¡œì íŠ¸ ì´ë¦„
          # project.pbxprojì—ì„œ MARKETING_VERSION ì¶”ì¶œ (ì˜ˆ: 1.0.0)
          MARKETING_VERSION=$(grep -m 1 "MARKETING_VERSION = " "${PROJECT_NAME}/${PROJECT_NAME}.xcodeproj/project.pbxproj" | sed 's/.*MARKETING_VERSION = \(.*\);/\1/' | tr -d ' ')

          # project.pbxprojì—ì„œ CURRENT_PROJECT_VERSION ì¶”ì¶œ (ë¹Œë“œ ë²ˆí˜¸, ì˜ˆ: 42)
          BUILD_NUMBER=$(grep -m 1 "CURRENT_PROJECT_VERSION = " "${PROJECT_NAME}/${PROJECT_NAME}.xcodeproj/project.pbxproj" | sed 's/.*CURRENT_PROJECT_VERSION = \(.*\);/\1/' | tr -d ' ')
          
          echo "marketing_version=$MARKETING_VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          
          echo "ğŸ“± Extracted Marketing Version: $MARKETING_VERSION"
          echo "ğŸ”¢ Extracted Build Number: $BUILD_NUMBER"
      
      # ë²„ì „ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
      - name: Check if tag exists
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.xcode_version.outputs.marketing_version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Tag v${{ steps.xcode_version.outputs.marketing_version }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Tag v${{ steps.xcode_version.outputs.marketing_version }} does not exist"
          fi

      # PR ì¡°íšŒ
      - name: Get merged PRs since last release
        # ë™ì¼í•œ ë²„ì „ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš°ë§Œ ì‹¤í–‰
        if: steps.check_tag.outputs.exists == 'false'
        id: get_prs
        uses: actions/github-script@v7
        with:
          script: |
            const latestRelease = await github.rest.repos.getLatestRelease({
              owner: context.repo.owner,
              repo: context.repo.repo
            }).catch(() => null);
            
            const since = latestRelease?.data.published_at || '';
            
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              base: 'main',
              sort: 'updated',
              direction: 'desc'
            });
            
            const mergedPRs = pulls.filter(pr => {
              if (!pr.merged_at) return false;
              if (!since) return true;  // ì²« ë¦´ë¦¬ì¦ˆë©´ ëª¨ë“  PR í¬í•¨
              return new Date(pr.merged_at) > new Date(since);
            });
            
            // ë¼ë²¨ë³„ë¡œ PR ë¶„ë¥˜
            const features = mergedPRs.filter(pr => 
              pr.labels.some(l => l.name === 'Feature' || l.name === 'UI' || l.name === 'Design')
            );
            const bugfixes = mergedPRs.filter(pr => 
              pr.labels.some(l => l.name === 'Fix' || l.name === 'Bug')
            );
            const maintenance = mergedPRs.filter(pr => 
              pr.labels.some(l => l.name === 'Chore' || l.name === 'Refactor' || l.name === 'Remove' || l.name === 'Docs' || l.name === 'Test')
            );
            // ì œì™¸í•  ë¼ë²¨: Someday, ReleaseëŠ” ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ì— í¬í•¨í•˜ì§€ ì•ŠìŒ
            const others = mergedPRs.filter(pr => 
              !pr.labels.some(l => ['Feature', 'UI', 'Design', 'Fix', 'Bug', 'Chore', 'Refactor', 'Remove', 'Docs', 'Test', 'Someday', 'Release'].includes(l.name))
            );
            
            let releaseNotes = '## What\'s Changed\n\n';
            
            if (features.length > 0) {
              releaseNotes += '### ğŸš€ New Features\n';
              features.forEach(pr => {
                releaseNotes += `- ${pr.title} @${pr.user.login} (#${pr.number})\n`;   
              });
              releaseNotes += '\n';
            }
            
            if (bugfixes.length > 0) {
              releaseNotes += '### ğŸ› Bug Fixes\n';
              bugfixes.forEach(pr => {
                releaseNotes += `- ${pr.title} @${pr.user.login} (#${pr.number})\n`;
              });
              releaseNotes += '\n';
            }
            
            if (maintenance.length > 0) {
              releaseNotes += '### ğŸš© Maintenance\n';
              maintenance.forEach(pr => {
                releaseNotes += `- ${pr.title} @${pr.user.login} (#${pr.number})\n`;
              });
              releaseNotes += '\n';
            }
            
            if (others.length > 0) {
              releaseNotes += '### ğŸ“ Others\n';
              others.forEach(pr => {
                releaseNotes += `- ${pr.title} @${pr.user.login} (#${pr.number})\n`;
              });
            }
            
            return releaseNotes;
      
      - name: Create or Update Release Draft
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const marketingVersion = '${{ steps.xcode_version.outputs.marketing_version }}';
            const buildNumber = '${{ steps.xcode_version.outputs.build_number }}';
            const tagName = `v${marketingVersion}`;
            const releaseNotes = ${{ steps.get_prs.outputs.result }};
            
            // ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ì— ë²„ì „ ì •ë³´ ì¶”ê°€
            const fullReleaseNotes = `**Version**: ${marketingVersion}\n**Build**: ${buildNumber}\n\n${releaseNotes}`;
            
            // ê¸°ì¡´ draft ë¦´ë¦¬ì¦ˆ ì°¾ê¸°
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const existingDraft = releases.find(r => r.draft && r.tag_name === tagName);
            
            if (existingDraft) {
              // ì—…ë°ì´íŠ¸
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: existingDraft.id,
                body: fullReleaseNotes
              });
              console.log(`âœ… Updated draft release: ${tagName} (Build: ${buildNumber})`);
            } else {
              // ìƒˆë¡œ ìƒì„±
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: `v${marketingVersion}`,
                body: fullReleaseNotes,
                draft: false,
                prerelease: false
              });
              console.log(`âœ… Created draft release: ${tagName} (Build: ${buildNumber})`);
            }
